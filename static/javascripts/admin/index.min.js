var opt={basePath:"/plugin/epiceditor",theme:{base:"/themes/base/epiceditor.css",preview:"/themes/preview/github.css",editor:"/themes/editor/epic-dark.css"},autogrow:{minHeight:500,maxHeight:500}};var editor=new EpicEditor(opt).load();$(".save").on("click",function(){editor.save();var g=$("input.title").val();var a=editor.exportFile();var e=$("input.date").val();var f=$("input.category").val();var d=$("input.tags").val();if(g===""||a===""||e===""||f===""||d===""){alert("有什么没填哦！");return}var b={title:g,body:a,date:e,category:f,tags:d};var h=$("input.id").val();var c="/admin/post";if(h!==""){c="/admin/update";b.id=h}$.post(c,b,function(i){if(i==="1"){alert("success")}})});$(".nav").on("click",function(b){var a=$(b.target);if(a.hasClass("active")){return}$(".navbar .active").removeClass("active");a.addClass("active");if(a.hasClass("nav-home")){$(".list").show();$(".editor").hide();$(".image").hide()}else{if(a.hasClass("nav-editor")){$(".list").hide();$(".editor").show();resetEditor();$(".image").hide()}else{if(a.hasClass("nav-image")){$(".list").hide();$(".editor").hide();$(".image").show()}}}});$(".list ul").on("click",function(c){var b=$(c.target);if(b[0].nodeName!=="A"){return}var d=b.attr("data-id");if(b.hasClass("edit")){$.get("/admin/post/"+d,function(g){$(".list").hide();$(".nav-home").removeClass("active");$(".editor").show();$(".nav-editor").addClass("active");resetEditor();var f=JSON.parse(g);$(".editor label:first").html("Edit a post:");$("input.id").val(f._id);$("input.title").val(f.title);var e=new Date(f.date);$("input.date").val(dateToStr(e));$("input.category").val(f.categories);$("input.tags").val(f.tags);editor.importFile(null,f.body)})}else{if(b.hasClass("delete")){var a=b.attr("data-deleted")==="true"?false:true;$.post("/admin/update",{id:d,deleted:a},function(e){if(e==="1"){b.attr("data-deleted",a);b.html(a?"恢复":"删除")}})}}});$("#upload").on("click",function(b){if($("#imagesForUpload")[0].files.length===0){b.preventDefault();return false}var a=new FormData(document.getElementById("uploadForm"));$.ajax({url:"/admin/upload",type:"POST",data:a,processData:false,contentType:false,success:function(d){if(d==="0"){alert("上传失败")}else{var c=JSON.parse(d);c.forEach(function(h){var f=h.name;var e="/image/"+f;var g='<li><i class="deleteImage" data-href="'+e+'">X</i><a href="'+e+'" target="_blank"><img src="'+e+'"></a></li>';$(".imageList ul").append($(g))})}},error:function(){alert("上传失败")}})});$(".imageList").on("click",function(d){var c=$(d.target);if(!c.hasClass("deleteImage")){return}var a=c.data("href");var b=a.slice(a.lastIndexOf("/")+1);deleteImage(b,function(){c.parent().remove()},function(){alert("删除失败")})});function dateToStr(d){var e=d.getFullYear();var f=("0"+(d.getMonth()+1)).slice(-2);var b=("0"+d.getDate()).slice(-2);var a=("0"+d.getHours()).slice(-2);var g=("0"+d.getMinutes()).slice(-2);var c=("0"+d.getSeconds()).slice(-2);return e+"/"+f+"/"+b+" "+a+":"+g+":"+c}function resetEditor(){$(".editor label:first").html("Add a post:");$("input.post").each(function(c,d){$(d).val("")});var b=$(".post.date");var a=new Date();b.val(dateToStr(a));editor=new EpicEditor(opt).load();editor.importFile(null,"")}function showList(){var a=$(".list ul");a.html("<li>Loading...</li>");$.get("/admin/posts",function(c){c=JSON.parse(c);var b="";c.forEach(function(d){b+='<li><a class="edit" data-id="'+d._id+'">'+d.title+'</a><a class="delete" data-id="'+d._id+'" data-deleted="'+d.deleted+'">'+(d.deleted?"恢复":"删除")+"</a></li>"});a.html(b)})}function showImageList(){var a=$(".imageList ul");a.html("<li>Loading...</li>");$.get("/admin/images",function(c){c=JSON.parse(c);var b="";c.forEach(function(d){b+='<li><i class="deleteImage" data-href="'+d+'">X</i><a href="'+d+'" target="_blank"><img src="'+d+'"></a></li>'});a.html(b)})}function deleteImage(b,a,c){$.post("/admin/deleteImage",{name:b},function(d){if(d==="1"){a&&a()}else{if(d==="0"){c&&c()}}})}showList();showImageList();